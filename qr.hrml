<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Leitor QR</title>
<style>
  body{margin:0;padding:10px;font-family:sans-serif;text-align:center;background:#f4f4f4}
  video{width:100%;max-height:50vh;background:#000;border-radius:8px}
  textarea{width:100%;height:130px;margin-top:15px;font-size:16px;padding:10px;border-radius:8px}
  button{padding:12px 18px;font-size:16px;margin-top:12px;border-radius:8px}
</style>
</head>
<body>

<h3>Leitor de QR</h3>

<video id="video" autoplay playsinline muted></video>

<button id="start">Iniciar câmera</button>

<textarea id="output" placeholder="O conteúdo do QR aparecerá aqui"></textarea>

<!-- jsQR (fallback universal do iPhone) -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
const video = document.getElementById('video');
const output = document.getElementById('output');
let stream = null;
let raf = null;

document.getElementById('start').onclick = startCamera;

async function startCamera(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal: "environment" } },
      audio:false
    });

    video.srcObject = stream;
    await new Promise(r => video.onloadedmetadata = r);

    scanLoop();

  } catch (e) {
    output.value = "Erro ao acessar a câmera: " + e;
  }
}

function scanLoop(){
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  function scan(){
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(img.data, img.width, img.height);

    if(code){
      output.value = code.data;
      stopCamera();
      return;
    }

    raf = requestAnimationFrame(scan);
  }

  scan();
}

function stopCamera(){
  if(raf) cancelAnimationFrame(raf);
  if(stream){
    stream.getTracks().forEach(t => t.stop());
  }
}
</script>

</body>
</html>