<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Coleta de Pre√ßos</title>

  <meta name="viewport"
        content="width=device-width,
                 initial-scale=1,
                 maximum-scale=1,
                 user-scalable=no">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>

<body class="bg-light">

<div class="container mt-4">

  <!-- Produto atual -->
  <div class="card mb-3">
    <div class="card-body">

      <h5 id="lojaAtual">Nenhum produto</h5>
      <p><strong>Produto:</strong> <span id="nomeAtual">-</span></p>
      <p><strong>EAN:</strong> <span id="eanAtual">-</span></p>
      <p><strong>Pre√ßo (kg):</strong> R$ <span id="precoAtual">00.00</span></p>

      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-secondary flex-fill" onclick="anterior()">&lt;&lt;</button>
        <button class="btn btn-warning flex-fill" onclick="editarProduto()">Editar</button>
        <button class="btn btn-primary flex-fill" onclick="novoProduto()">Novo</button>
        <button class="btn btn-secondary flex-fill" onclick="proximo()">&gt;&gt;</button>
      </div>

    </div>
  </div>

  <!-- Formul√°rio -->
  <div class="card d-none" id="formCard">
    <div class="card-body">

      <h6 id="formTitulo">Novo Produto</h6>

      <div class="mb-2 d-flex gap-2">
        <select id="formLoja" class="form-select"></select>
        <button class="btn btn-outline-primary" onclick="novaLoja()">+</button>
      </div>

      <div class="mb-2">
        <input id="formNome" class="form-control" placeholder="Nome do produto">
      </div>

      <div class="mb-2 d-flex gap-2">
        <input id="formEan" class="form-control" placeholder="EAN">
        <button class="btn btn-outline-secondary" onclick="abrirLeitorEAN('formEan')">üì∑</button>
      </div>

      <div class="mb-3">
        <input id="formPreco" class="form-control" type="number" step="0.01">
      </div>

      <!-- BOT√ïES -->
      <div class="d-flex gap-2">
        <button class="btn btn-success flex-fill" onclick="salvarProduto()">Salvar</button>
        <button class="btn btn-secondary flex-fill" onclick="cancelarEdicao()">Cancelar</button>
        <button class="btn btn-danger flex-fill" id="btnExcluir" onclick="excluirProduto()">Excluir</button>
      </div>

    </div>
  </div>

</div>

<!-- Modal Scanner -->
<div class="modal fade" id="modalScanner" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Leitura de C√≥digo EAN</h5>
        <button class="btn-close" onclick="fecharLeitor()"></button>
      </div>

      <div class="modal-body p-0">
        <div id="scanner" style="width:100%; height:100%;"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-danger w-100" onclick="fecharLeitor()">Cancelar</button>
      </div>

    </div>
  </div>
</div>

<script>
let produtos = JSON.parse(localStorage.getItem("produto")) || [];
let lojas = JSON.parse(localStorage.getItem("lojas")) || [];
let indexAtual = 0;
let modoEdicao = false;

let campoEanDestino = null;
let quaggaAtivo = false;

/* Migra√ß√£o */
if (lojas.length === 0 && produtos.length > 0) {
  lojas = [...new Set(produtos.map(p => p.loja).filter(l => l))];
  localStorage.setItem("lojas", JSON.stringify(lojas));
}

function salvarProdutos() {
  localStorage.setItem("produto", JSON.stringify(produtos));
}

function salvarLojas() {
  localStorage.setItem("lojas", JSON.stringify(lojas));
}

function atualizarSelectLojas(sel = "") {
  formLoja.innerHTML = "";
  lojas.forEach(l => {
    const o = document.createElement("option");
    o.value = l;
    o.text = l;
    if (l === sel) o.selected = true;
    formLoja.appendChild(o);
  });
}

function mostrarProduto() {
  if (!produtos.length) {
    lojaAtual.innerText = "Nenhum produto";
    nomeAtual.innerText = "-";
    eanAtual.innerText = "-";
    precoAtual.innerText = "00.00";
    return;
  }
  const p = produtos[indexAtual];
  lojaAtual.innerText = p.loja;
  nomeAtual.innerText = p.nome;
  eanAtual.innerText = p.ean;
  precoAtual.innerText = p.preco.toFixed(2);
}

function proximo() {
  if (indexAtual < produtos.length - 1) {
    indexAtual++;
    mostrarProduto();
  }
}

function anterior() {
  if (indexAtual > 0) {
    indexAtual--;
    mostrarProduto();
  }
}

function novoProduto() {
  modoEdicao = false;
  formTitulo.innerText = "Novo Produto";
  formNome.value = "";
  formEan.value = "";
  formPreco.value = "0.00";
  atualizarSelectLojas();
  btnExcluir.style.visibility = "hidden";
  formCard.classList.remove("d-none");
}

function editarProduto() {
  if (!produtos.length) return;
  modoEdicao = true;
  const p = produtos[indexAtual];
  formTitulo.innerText = "Editar Produto";
  formNome.value = p.nome;
  formEan.value = p.ean;
  formPreco.value = p.preco.toFixed(2);
  atualizarSelectLojas(p.loja);
  btnExcluir.style.visibility = "visible";
  formCard.classList.remove("d-none");
}

function salvarProduto() {
  const p = {
    loja: formLoja.value,
    nome: formNome.value || "",
    ean: formEan.value || "",
    preco: parseFloat(formPreco.value) || 0
  };

  if (modoEdicao) {
    produtos[indexAtual] = p;
  } else {
    produtos.push(p);
    indexAtual = produtos.length - 1;
  }

  salvarProdutos();
  mostrarProduto();
  formCard.classList.add("d-none");
}

function cancelarEdicao() {
  formCard.classList.add("d-none");
}

function excluirProduto() {
  if (!modoEdicao) return;

  if (!confirm("Deseja realmente excluir este produto?")) return;

  produtos.splice(indexAtual, 1);

  if (indexAtual > 0) indexAtual--;

  salvarProdutos();
  mostrarProduto();
  formCard.classList.add("d-none");
}

function novaLoja() {
  const n = prompt("Nome da nova loja:");
  if (!n) return;
  if (lojas.includes(n)) return alert("Esta loja j√° existe.");
  lojas.push(n);
  salvarLojas();
  atualizarSelectLojas(n);
}

/* QUAGGA */
function abrirLeitorEAN(idCampo) {
  campoEanDestino = document.getElementById(idCampo);
  const modal = new bootstrap.Modal(modalScanner);
  modal.show();
  setTimeout(iniciarQuagga, 300);
}

function iniciarQuagga() {
  if (quaggaAtivo) return;
  quaggaAtivo = true;

  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: document.querySelector("#scanner"),
      constraints: {
        facingMode: "environment",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      area: { top: "30%", right: "10%", left: "10%", bottom: "30%" }
    },
    decoder: { readers: ["ean_reader"] },
    locate: true,
    numOfWorkers: 1,
    frequency: 5
  }, err => {
    if (err) {
      alert("Erro ao acessar a c√¢mera");
      fecharLeitor();
      return;
    }
    Quagga.start();
  });

  Quagga.offDetected();
  Quagga.onDetected(onDetectado);
}

function onDetectado(r) {
  if (!r?.codeResult?.code) return;
  campoEanDestino.value = r.codeResult.code;
  fecharLeitor();
}

function fecharLeitor() {
  if (quaggaAtivo) {
    Quagga.stop();
    Quagga.offDetected(onDetectado);
    quaggaAtivo = false;
  }
  const modal = bootstrap.Modal.getInstance(modalScanner);
  if (modal) modal.hide();
}

mostrarProduto();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>