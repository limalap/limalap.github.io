<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Coleta de Pre칞os</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4">

  <!-- Produto atual -->
  <div class="card mb-3">
    <div class="card-body">

      <h5 id="lojaAtual">Nenhum produto</h5>
      <p><strong>Produto:</strong> <span id="nomeAtual">-</span></p>
      <p><strong>EAN:</strong> <span id="eanAtual">-</span></p>
      <p><strong>Pre칞o (kg):</strong> R$ <span id="precoAtual">00.00</span></p>

      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-secondary flex-fill" onclick="anterior()">&lt;&lt;</button>
        <button class="btn btn-warning flex-fill" onclick="editarProduto()">Editar</button>
        <button class="btn btn-primary flex-fill" onclick="novoProduto()">Novo</button>
        <button class="btn btn-secondary flex-fill" onclick="proximo()">&gt;&gt;</button>
      </div>

    </div>
  </div>

  <!-- Formul치rio -->
  <div class="card d-none" id="formCard">
    <div class="card-body">

      <h6 id="formTitulo">Novo Produto</h6>

      <div class="mb-2 d-flex gap-2">
        <select id="formLoja" class="form-select"></select>
        <button class="btn btn-outline-primary" onclick="novaLoja()">+</button>
      </div>

      <div class="mb-2">
        <input id="formNome" class="form-control" placeholder="Nome do produto">
      </div>

      <!-- EAN com bot칚o de c칙mera -->
      <div class="mb-2 d-flex gap-2">
        <input id="formEan" class="form-control" placeholder="EAN">
        <button class="btn btn-outline-secondary" onclick="abrirLeitorEAN('formEan')">游닝</button>
      </div>

      <div class="mb-3">
        <input id="formPreco" class="form-control" type="number" step="0.01">
      </div>

      <button class="btn btn-success w-100" onclick="salvarProduto()">Salvar</button>

    </div>
  </div>

</div>

<!-- Modal Leitor -->
<div class="modal fade" id="modalScanner" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Leitura de C칩digo EAN</h5>
        <button class="btn-close" onclick="fecharLeitor()"></button>
      </div>

      <div class="modal-body p-0">
        <video id="video" autoplay playsinline style="width:100%; height:100%;"></video>
      </div>

      <div class="modal-footer">
        <button class="btn btn-danger w-100" onclick="fecharLeitor()">Cancelar</button>
      </div>

    </div>
  </div>
</div>

<script>
  let produtos = JSON.parse(localStorage.getItem("produto")) || [];
  let lojas = JSON.parse(localStorage.getItem("lojas")) || [];
  let indexAtual = 0;
  let modoEdicao = false;

  /* ===== leitor ===== */
  let stream = null;
  let detector = null;
  let campoEanDestino = null;
  let lendo = false;

  if (lojas.length === 0 && produtos.length > 0) {
    lojas = [...new Set(produtos.map(p => p.loja).filter(l => l))];
    localStorage.setItem("lojas", JSON.stringify(lojas));
  }

  function salvarProdutos() {
    localStorage.setItem("produto", JSON.stringify(produtos));
  }

  function salvarLojas() {
    localStorage.setItem("lojas", JSON.stringify(lojas));
  }

  function atualizarSelectLojas(sel = "") {
    const s = document.getElementById("formLoja");
    s.innerHTML = "";
    lojas.forEach(l => {
      const o = document.createElement("option");
      o.value = l;
      o.text = l;
      if (l === sel) o.selected = true;
      s.appendChild(o);
    });
  }

  function mostrarProduto() {
    if (!produtos.length) {
      lojaAtual.innerText = "Nenhum produto";
      nomeAtual.innerText = "-";
      eanAtual.innerText = "-";
      precoAtual.innerText = "00.00";
      return;
    }
    const p = produtos[indexAtual];
    lojaAtual.innerText = p.loja;
    nomeAtual.innerText = p.nome;
    eanAtual.innerText = p.ean;
    precoAtual.innerText = p.preco.toFixed(2);
  }

  function proximo() { if (indexAtual < produtos.length - 1) { indexAtual++; mostrarProduto(); } }
  function anterior() { if (indexAtual > 0) { indexAtual--; mostrarProduto(); } }

  function novoProduto() {
    modoEdicao = false;
    formTitulo.innerText = "Novo Produto";
    formNome.value = "";
    formEan.value = "";
    formPreco.value = "0.00";
    atualizarSelectLojas();
    formCard.classList.remove("d-none");
  }

  function editarProduto() {
    if (!produtos.length) return;
    modoEdicao = true;
    const p = produtos[indexAtual];
    formTitulo.innerText = "Editar Produto";
    formNome.value = p.nome;
    formEan.value = p.ean;
    formPreco.value = p.preco.toFixed(2);
    atualizarSelectLojas(p.loja);
    formCard.classList.remove("d-none");
  }

  function salvarProduto() {
    const p = {
      loja: formLoja.value,
      nome: formNome.value || "",
      ean: formEan.value || "",
      preco: parseFloat(formPreco.value) || 0
    };

    if (modoEdicao) {
      produtos[indexAtual] = p;
    } else {
      produtos.push(p);
      indexAtual = produtos.length - 1;
    }

    salvarProdutos();
    mostrarProduto();
    formCard.classList.add("d-none");
  }

  function novaLoja() {
    const n = prompt("Nome da nova loja:");
    if (!n) return;
    if (lojas.includes(n)) return alert("Esta loja j치 existe.");
    lojas.push(n);
    salvarLojas();
    atualizarSelectLojas(n);
  }

  /* ===== LEITOR EAN NATIVO ===== */

  async function abrirLeitorEAN(idCampo) {
    campoEanDestino = document.getElementById(idCampo);

    if (!("BarcodeDetector" in window)) {
      alert("Leitura por c칙mera n칚o suportada neste navegador.");
      return;
    }

    detector = new BarcodeDetector({ formats: ["ean_13", "ean_8"] });

    const modal = new bootstrap.Modal(modalScanner);
    modal.show();

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } }
      });

      video.srcObject = stream;
      lendo = true;
      requestAnimationFrame(loopLeitura);

    } catch (e) {
      alert("N칚o foi poss칤vel acessar a c칙mera.");
      fecharLeitor();
    }
  }

  async function loopLeitura() {
    if (!lendo) return;

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      try {
        const codigos = await detector.detect(video);
        if (codigos.length) {
          campoEanDestino.value = codigos[0].rawValue;
          fecharLeitor();
          return;
        }
      } catch (e) {}
    }
    requestAnimationFrame(loopLeitura);
  }

  function fecharLeitor() {
    lendo = false;
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    const m = bootstrap.Modal.getInstance(modalScanner);
    if (m) m.hide();
  }

  mostrarProduto();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>