<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Coleta de PreÃ§os</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/browser@0.1.4/umd/index.min.js"></script>
</head>

<body class="bg-light">

<div class="container mt-4">

  <!-- Produto atual -->
  <div class="card mb-3">
    <div class="card-body">

      <h5 id="lojaAtual">Nenhum produto</h5>
      <p><strong>Produto:</strong> <span id="nomeAtual">-</span></p>
      <p><strong>EAN:</strong> <span id="eanAtual">-</span></p>
      <p><strong>PreÃ§o (kg):</strong> R$ <span id="precoAtual">00.00</span></p>

      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-secondary flex-fill" onclick="anterior()">&lt;&lt;</button>
        <button class="btn btn-warning flex-fill" onclick="editarProduto()">Editar</button>
        <button class="btn btn-primary flex-fill" onclick="novoProduto()">Novo</button>
        <button class="btn btn-secondary flex-fill" onclick="proximo()">&gt;&gt;</button>
      </div>

    </div>
  </div>

  <!-- FormulÃ¡rio -->
  <div class="card d-none" id="formCard">
    <div class="card-body">

      <h6 id="formTitulo">Novo Produto</h6>

      <div class="mb-2 d-flex gap-2">
        <select id="formLoja" class="form-select"></select>
        <button class="btn btn-outline-primary" onclick="novaLoja()">+</button>
      </div>

      <div class="mb-2">
        <input id="formNome" class="form-control" placeholder="Nome do produto">
      </div>

      <div class="mb-2 d-flex gap-2">
        <input id="formEan" class="form-control" placeholder="EAN">
        <button class="btn btn-outline-secondary" onclick="abrirLeitorEAN('formEan')">ðŸ“·</button>
      </div>

      <div class="mb-3">
        <input id="formPreco" class="form-control" type="number" step="0.01">
      </div>

      <button class="btn btn-success w-100" onclick="salvarProduto()">Salvar</button>

    </div>
  </div>

</div>

<!-- Modal Scanner -->
<div class="modal fade" id="modalScanner" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Leitura de CÃ³digo EAN</h5>
        <button class="btn-close" onclick="fecharLeitor()"></button>
      </div>

      <div class="modal-body text-center">
        <select id="cameraSelect" class="form-select mb-2"></select>
        <video id="video" style="width:100%;"></video>
      </div>

      <div class="modal-footer">
        <button class="btn btn-danger w-100" onclick="fecharLeitor()">Cancelar</button>
      </div>

    </div>
  </div>
</div>

<script>
  let produtos = JSON.parse(localStorage.getItem("produto")) || [];
  let lojas = JSON.parse(localStorage.getItem("lojas")) || [];
  let indexAtual = 0;
  let modoEdicao = false;

  let leitor = null;
  let campoEanDestino = null;

  if (lojas.length === 0 && produtos.length > 0) {
    lojas = [...new Set(produtos.map(p => p.loja).filter(l => l))];
    localStorage.setItem("lojas", JSON.stringify(lojas));
  }

  function salvarProdutos() {
    localStorage.setItem("produto", JSON.stringify(produtos));
  }

  function salvarLojas() {
    localStorage.setItem("lojas", JSON.stringify(lojas));
  }

  function atualizarSelectLojas(sel = "") {
    const s = document.getElementById("formLoja");
    s.innerHTML = "";
    lojas.forEach(l => {
      const o = document.createElement("option");
      o.value = l;
      o.text = l;
      if (l === sel) o.selected = true;
      s.appendChild(o);
    });
  }

  function mostrarProduto() {
    if (!produtos.length) return;
    const p = produtos[indexAtual];
    lojaAtual.innerText = p.loja;
    nomeAtual.innerText = p.nome;
    eanAtual.innerText = p.ean;
    precoAtual.innerText = p.preco.toFixed(2);
  }

  function proximo(){ if(indexAtual < produtos.length-1){ indexAtual++; mostrarProduto();}}
  function anterior(){ if(indexAtual > 0){ indexAtual--; mostrarProduto();}}

  function novoProduto(){
    modoEdicao = false;
    formTitulo.innerText = "Novo Produto";
    formNome.value = "";
    formEan.value = "";
    formPreco.value = "0.00";
    atualizarSelectLojas();
    formCard.classList.remove("d-none");
  }

  function editarProduto(){
    if(!produtos.length) return;
    modoEdicao = true;
    const p = produtos[indexAtual];
    formTitulo.innerText = "Editar Produto";
    formNome.value = p.nome;
    formEan.value = p.ean;
    formPreco.value = p.preco.toFixed(2);
    atualizarSelectLojas(p.loja);
    formCard.classList.remove("d-none");
  }

  function salvarProduto(){
    const p = {
      loja: formLoja.value,
      nome: formNome.value,
      ean: formEan.value,
      preco: parseFloat(formPreco.value) || 0
    };
    modoEdicao ? produtos[indexAtual]=p : produtos.push(p);
    indexAtual = produtos.length-1;
    salvarProdutos();
    mostrarProduto();
    formCard.classList.add("d-none");
  }

  function novaLoja(){
    const n = prompt("Nome da nova loja:");
    if(!n || lojas.includes(n)) return alert("Loja invÃ¡lida");
    lojas.push(n);
    salvarLojas();
    atualizarSelectLojas(n);
  }

  /* ===== LEITOR ZXING ===== */

  async function abrirLeitorEAN(idCampo){
    campoEanDestino = document.getElementById(idCampo);
    leitor = new ZXing.BrowserMultiFormatReader();

    const modal = new bootstrap.Modal(modalScanner);
    modal.show();

    const cameras = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
    cameraSelect.innerHTML = "";

    cameras.forEach((c,i)=>{
      const o = document.createElement("option");
      o.value = c.deviceId;
      o.text = c.label || `CÃ¢mera ${i+1}`;
      cameraSelect.appendChild(o);
    });

    const traseira = cameras.find(c=>/back|rear|environment/i.test(c.label));
    cameraSelect.value = traseira ? traseira.deviceId : cameras[0].deviceId;

    iniciarLeitura(cameraSelect.value);

    cameraSelect.onchange = () => iniciarLeitura(cameraSelect.value);
  }

  function iniciarLeitura(deviceId){
    leitor.reset();
    leitor.decodeFromVideoDevice(deviceId, "video", (res,err)=>{
      if(res){
        campoEanDestino.value = res.text;
        fecharLeitor();
      }
    });
  }

  function fecharLeitor(){
    if(leitor) leitor.reset();
    bootstrap.Modal.getInstance(modalScanner)?.hide();
  }

  mostrarProduto();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>