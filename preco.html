<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Coleta de Pre√ßos</title>

  <meta name="viewport"
        content="width=device-width,
                 initial-scale=1,
                 maximum-scale=1,
                 user-scalable=no">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>

<body class="bg-light">

<div class="container mt-4">
  <div class="card mb-3">
    <div class="card-body">

      <div class="d-flex gap-2 mb-2">
        <select id="filtroLoja" class="form-select" onchange="aplicarFiltros()"></select>
        <select id="filtroSetor" class="form-select" onchange="aplicarFiltros()"></select>
      </div>

      <div class="d-flex gap-2">
        <input id="campoBusca" class="form-control"
               placeholder="Buscar por nome ou EAN"
               oninput="buscarProdutos()">

        <button class="btn btn-outline-secondary"
                onclick="abrirLeitorEAN('campoBusca')">üì∑</button>
      </div>

    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">

      <h5 id="lojaAtual">Nenhum produto</h5>
      <p><strong>Setor:</strong> <span id="setorAtual">-</span></p>
      <p><strong>Produto:</strong> <span id="nomeAtual">-</span></p>
      <p><strong>EAN:</strong> <span id="eanAtual">-</span></p>
      <p><strong>Pre√ßo (kg):</strong> R$ <span id="precoAtual">00.00</span></p>

      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-secondary flex-fill" onclick="anterior()">&lt;&lt;</button>
        <button class="btn btn-warning flex-fill" onclick="editarProduto()">Editar</button>
        <button class="btn btn-primary flex-fill" onclick="novoProduto()">Novo</button>
        <button class="btn btn-secondary flex-fill" onclick="proximo()">&gt;&gt;</button>
      </div>

    </div>
  </div>

  <div class="card d-none" id="formCard">
    <div class="card-body">

      <h6 id="formTitulo">Novo Produto</h6>

      <div class="mb-2 d-flex gap-2">
        <select id="formLoja" class="form-select"></select>
        <button class="btn btn-outline-primary" onclick="novaLoja()">+</button>
      </div>

      <div class="mb-2 d-flex gap-2">
        <select id="formSetor" class="form-select">
          <option value="">(sem setor)</option>
        </select>
        <button class="btn btn-outline-primary" onclick="novoSetor()">+</button>
      </div>

      <div class="mb-2">
        <input id="formNome" class="form-control" placeholder="Nome do produto">
      </div>

      <div class="mb-2 d-flex gap-2">
        <input id="formEan" class="form-control" placeholder="EAN">
        <button class="btn btn-outline-secondary" onclick="abrirLeitorEAN('formEan')">üì∑</button>
      </div>

      <div class="mb-3">
        <input id="formPreco" class="form-control" type="number" step="0.01">
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-success flex-fill" onclick="salvarProduto()">Salvar</button>
        <button class="btn btn-secondary flex-fill" onclick="cancelarEdicao()">Cancelar</button>
        <button class="btn btn-danger flex-fill" id="btnExcluir" onclick="excluirProduto()">Excluir</button>
      </div>

    </div>
  </div>

</div>

<div class="modal fade" id="modalScanner" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Leitura de C√≥digo EAN</h5>
        <button class="btn-close" onclick="fecharLeitor()"></button>
      </div>

      <div class="modal-body p-0">
        <div id="scanner" style="width:100%; height:100%;"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-danger w-100" onclick="fecharLeitor()">Cancelar</button>
      </div>

    </div>
  </div>
</div>

<script>
let produtos = JSON.parse(localStorage.getItem("produto")) || [];
let lojas    = JSON.parse(localStorage.getItem("lojas")) || [];
let setores  = JSON.parse(localStorage.getItem("setores")) || [];

let indexAtual = 0;
let modoEdicao = false;

let campoEanDestino = null;
let quaggaAtivo = false;

if (lojas.length === 0 && produtos.length > 0) {
  lojas = [...new Set(produtos.map(p => p.loja).filter(l => l))];
  localStorage.setItem("lojas", JSON.stringify(lojas));
}

if (setores.length === 0 && produtos.length > 0) {
  setores = [...new Set(produtos.map(p => p.setor).filter(s => s))];
  localStorage.setItem("setores", JSON.stringify(setores));
}

function salvarProdutos() {
  localStorage.setItem("produto", JSON.stringify(produtos));
}
function salvarLojas() {
  localStorage.setItem("lojas", JSON.stringify(lojas));
}
function salvarSetores() {
  localStorage.setItem("setores", JSON.stringify(setores));
}

function atualizarSelectLojas(sel = "") {
  formLoja.innerHTML = "";
  lojas.forEach(l => {
    const o = document.createElement("option");
    o.value = l;
    o.text  = l;
    if (l === sel) o.selected = true;
    formLoja.appendChild(o);
  });
}

function atualizarSelectSetores(sel = "") {
  formSetor.innerHTML = `<option value="">(sem setor)</option>`;
  setores.forEach(s => {
    const o = document.createElement("option");
    o.value = s;
    o.text  = s;
    if (s === sel) o.selected = true;
    formSetor.appendChild(o);
  });
}

function atualizarFiltroLojas(sel = "") {
  filtroLoja.innerHTML = `<option value="">Todas as lojas</option>`;
  lojas.forEach(l => {
    const o = document.createElement("option");
    o.value = l;
    o.text  = l;
    if (l === sel) o.selected = true;
    filtroLoja.appendChild(o);
  });
}

function atualizarFiltroSetores(sel = "") {
  filtroSetor.innerHTML = `<option value="">Todos os setores</option>`;
  setores.forEach(s => {
    const o = document.createElement("option");
    o.value = s;
    o.text  = s;
    if (s === sel) o.selected = true;
    filtroSetor.appendChild(o);
  });
}

function atualizarLojasESetores() {
  atualizarSelectLojas();
  atualizarFiltroLojas();
  atualizarSelectSetores();
  atualizarFiltroSetores();
}

// verifica se um produto passa pelos filtros atuais de loja / setor / busca
function passaFiltros(produto) {
  const lojaSel  = (filtroLoja.value  || "").trim();
  const setorSel = (filtroSetor.value || "").trim();
  const termoRaw = (campoBusca.value  || "").trim();

  // SEM texto na busca ‚Üí usa loja + setor (comportamento padr√£o)
  if (termoRaw === "") {
    if (lojaSel && (produto.loja || "") !== lojaSel) return false;
    if (setorSel && (produto.setor || "") !== setorSel) return false;
    return true;
  }

  // COM texto na busca ‚Üí setor √© ignorado, s√≥ loja (se houver) influencia
  const termo = termoRaw;
  if (lojaSel && (produto.loja || "") !== lojaSel) {
    // se nenhuma loja selecionada, N√ÉO entra aqui ‚Üí todas as lojas s√£o v√°lidas
    return false;
  }

  const ean    = (produto.ean  || "").toString();
  const nome   = (produto.nome || "").toLowerCase();
  const tLower = termo.toLowerCase();

  // Detecta "busca por EAN": s√≥ d√≠gitos e tamanho m√≠nimo (ajuste se quiser)
  const soDigitos = /^[0-9]+$/.test(termo);
  const isEAN = soDigitos && termo.length >= 8;

  if (isEAN) {
    // Busca exata de EAN ‚Üí mesmo EAN em v√°rias lojas ser√° listado separadamente
    return ean === termo;
  } else {
    // Busca textual por nome (cont√©m) OU parte do EAN
    const nomeMatch = nome.includes(tLower);
    const eanMatch  = ean.includes(termo);
    if (!nomeMatch && !eanMatch) return false;
    return true;
  }
}

// chamado pelos onchange de filtroLoja e filtroSetor
function aplicarFiltros() {
  indexAtual = 0;
  mostrarProduto();
}

// chamado pelo oninput do campo de busca
function buscarProdutos() {
  const termo = (campoBusca.value || "").trim();

  // Se estiver buscando, setor deixa de influenciar: for√ßa para "Todos os setores"
  if (termo !== "") {
    filtroSetor.value = "";
  }

  indexAtual = 0;
  mostrarProduto();
}

function mostrarProduto() {
  if (!produtos.length) {
    lojaAtual.innerText  = "Nenhum produto";
    setorAtual.innerText = "-";
    nomeAtual.innerText  = "-";
    eanAtual.innerText   = "-";
    precoAtual.innerText = "00.00";
    return;
  }

  const lojaSel  = (filtroLoja.value  || "").trim();
  const setorSel = (filtroSetor.value || "").trim();
  const termoRaw = (campoBusca.value  || "").trim();
  const buscando = termoRaw !== "";

  // sem filtros de loja/setor e sem busca ‚Üí comportamento original
  if (!buscando && !lojaSel && !setorSel) {
    if (indexAtual < 0) indexAtual = 0;
    if (indexAtual >= produtos.length) indexAtual = produtos.length - 1;

    const p0 = produtos[indexAtual];

    lojaAtual.innerText  = p0.loja  || "-";
    setorAtual.innerText = p0.setor || "-";
    nomeAtual.innerText  = p0.nome  || "-";
    eanAtual.innerText   = p0.ean   || "-";
    precoAtual.innerText = (p0.preco || 0).toFixed(2);
    return;
  }

  // com filtros (loja/setor) OU com busca: garantimos que indexAtual aponte para um produto que passa nos filtros
  let p = produtos[indexAtual];
  if (!p || !passaFiltros(p)) {
    // procura a partir do in√≠cio o primeiro produto que passa nos filtros
    let encontrado = -1;
    for (let i = 0; i < produtos.length; i++) {
      if (passaFiltros(produtos[i])) {
        encontrado = i;
        break;
      }
    }

    if (encontrado === -1) {
      // n√£o h√° produtos para essa combina√ß√£o de filtros / busca
      lojaAtual.innerText  = "Nenhum produto";
      setorAtual.innerText = "-";
      nomeAtual.innerText  = "-";
      eanAtual.innerText   = "-";
      precoAtual.innerText = "00.00";
      return;
    }

    indexAtual = encontrado;
    p = produtos[indexAtual];
  }

  lojaAtual.innerText  = p.loja  || "-";
  setorAtual.innerText = p.setor || "-";
  nomeAtual.innerText  = p.nome  || "-";
  eanAtual.innerText   = p.ean   || "-";
  precoAtual.innerText = (p.preco || 0).toFixed(2);
}

function proximo() {
  if (!produtos.length) return;

  const lojaSel  = (filtroLoja.value  || "").trim();
  const setorSel = (filtroSetor.value || "").trim();
  const termoRaw = (campoBusca.value  || "").trim();
  const buscando = termoRaw !== "";

  // sem filtros e sem busca: comportamento original
  if (!buscando && !lojaSel && !setorSel) {
    if (indexAtual < produtos.length - 1) {
      indexAtual++;
      mostrarProduto();
    }
    return;
  }

  // com filtros e/ou busca: avan√ßa at√© o pr√≥ximo produto que passa
  for (let i = indexAtual + 1; i < produtos.length; i++) {
    if (passaFiltros(produtos[i])) {
      indexAtual = i;
      mostrarProduto();
      return;
    }
  }
  // se n√£o achar mais nenhum que passe, n√£o faz nada (fim da lista filtrada)
}

function anterior() {
  if (!produtos.length) return;

  const lojaSel  = (filtroLoja.value  || "").trim();
  const setorSel = (filtroSetor.value || "").trim();
  const termoRaw = (campoBusca.value  || "").trim();
  const buscando = termoRaw !== "";

  // sem filtros e sem busca: comportamento original
  if (!buscando && !lojaSel && !setorSel) {
    if (indexAtual > 0) {
      indexAtual--;
      mostrarProduto();
    }
    return;
  }

  // com filtros e/ou busca: volta at√© o produto anterior que passa
  for (let i = indexAtual - 1; i >= 0; i--) {
    if (passaFiltros(produtos[i])) {
      indexAtual = i;
      mostrarProduto();
      return;
    }
  }
  // se n√£o achar outro que passe, n√£o faz nada (in√≠cio da lista filtrada)
}

function novoProduto() {
  modoEdicao = false;
  formTitulo.innerText = "Novo Produto";
  formNome.value = "";
  formEan.value = "";
  formPreco.value = "0.00";
  atualizarSelectLojas();
  atualizarSelectSetores();
  btnExcluir.style.visibility = "hidden";
  formCard.classList.remove("d-none");
}

function editarProduto() {
  if (!produtos.length) return;
  modoEdicao = true;
  const p = produtos[indexAtual];
  formTitulo.innerText = "Editar Produto";
  formNome.value = p.nome || "";
  formEan.value = p.ean || "";
  formPreco.value = (p.preco || 0).toFixed(2);
  atualizarSelectLojas(p.loja);
  atualizarSelectSetores(p.setor || "");
  btnExcluir.style.visibility = "visible";
  formCard.classList.remove("d-none");
}

function salvarProduto() {
  const produto = {
    loja:  formLoja.value || "",
    setor: formSetor.value || "",
    nome:  formNome.value || "",
    ean:   formEan.value  || "",
    preco: parseFloat(formPreco.value) || 0
  };

  if (modoEdicao) {
    produtos[indexAtual] = produto;
  } else {
    produtos.push(produto);
    indexAtual = produtos.length - 1;
  }

  salvarProdutos();
  atualizarLojasESetores(); // garante filtros atualizados para novas lojas/setores
  mostrarProduto();
  formCard.classList.add("d-none");
}

function cancelarEdicao() {
  formCard.classList.add("d-none");
}

function excluirProduto() {
  if (!modoEdicao) return;
  if (!confirm("Deseja realmente excluir este produto?")) return;

  produtos.splice(indexAtual, 1);
  if (indexAtual > 0) indexAtual--;

  salvarProdutos();
  mostrarProduto();
  formCard.classList.add("d-none");
}

function novaLoja() {
  const n = prompt("Nome da nova loja:");
  if (!n) return;
  if (lojas.includes(n)) return alert("Esta loja j√° existe.");
  lojas.push(n);
  salvarLojas();
  atualizarLojasESetores();
  atualizarSelectLojas(n);
  atualizarFiltroLojas(n);
}

function novoSetor() {
  const n = prompt("Nome do novo setor:");
  if (!n) return;
  if (setores.includes(n)) return alert("Este setor j√° existe.");
  setores.push(n);
  salvarSetores();
  atualizarLojasESetores();
  atualizarSelectSetores(n);
  atualizarFiltroSetores(n);
}

function abrirLeitorEAN(idCampo) {
  campoEanDestino = document.getElementById(idCampo);
  const modal = new bootstrap.Modal(modalScanner);
  modal.show();
  setTimeout(iniciarQuagga, 300);
}

function iniciarQuagga() {
  if (quaggaAtivo) return;
  quaggaAtivo = true;

  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: document.querySelector("#scanner"),
      constraints: {
        facingMode: "environment",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      area: { top: "30%", right: "10%", left: "10%", bottom: "30%" }
    },
    decoder: { readers: ["ean_reader"] },
    locate: true,
    numOfWorkers: 1,
    frequency: 5
  }, err => {
    if (err) {
      alert("Erro ao acessar a c√¢mera");
      fecharLeitor();
      return;
    }
    Quagga.start();
  });

  Quagga.offDetected();
  Quagga.onDetected(onDetectado);
}

function onDetectado(r) {
  if (!r?.codeResult?.code) return;
  campoEanDestino.value = r.codeResult.code;
  fecharLeitor();
}

function fecharLeitor() {
  if (quaggaAtivo) {
    Quagga.stop();
    Quagga.offDetected(onDetectado);
    quaggaAtivo = false;
  }
  const modal = bootstrap.Modal.getInstance(modalScanner);
  if (modal) modal.hide();
}

atualizarLojasESetores();
mostrarProduto();
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>