<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Coleta de PreÃ§os</title>

  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

  <style>
    html, body { touch-action: manipulation; }
    #cameraModal video { width: 100%; }
  </style>
</head>

<body class="bg-light">

<div class="container mt-3">

  <!-- FILTROS -->
  <div class="card mb-3">
    <div class="card-body">

      <div class="d-flex gap-2 mb-2">
        <select id="filtroLoja" class="form-select" onchange="aplicarFiltros()"></select>
        <select id="filtroSetor" class="form-select" onchange="aplicarFiltros()"></select>
      </div>

      <div class="d-flex gap-2">
        <input id="campoBusca" class="form-control"
               placeholder="Buscar por nome ou EAN"
               oninput="buscarProdutos()">
        <button class="btn btn-outline-secondary" onclick="abrirCameraBusca()">ðŸ“·</button>
      </div>

    </div>
  </div>

  <!-- PRODUTO -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 id="lojaAtual">Nenhum produto</h5>
      <p><strong>Setor:</strong> <span id="setorAtual">-</span></p>
      <p><strong>Produto:</strong> <span id="nomeAtual">-</span></p>
      <p><strong>EAN:</strong> <span id="eanAtual">-</span></p>
      <p><strong>PreÃ§o:</strong> R$ <span id="precoAtual">00.00</span></p>

      <div class="d-flex gap-2">
        <button class="btn btn-secondary flex-fill" onclick="anterior()">&lt;&lt;</button>
        <button class="btn btn-warning flex-fill" onclick="editarProduto()">Editar</button>
        <button class="btn btn-primary flex-fill" onclick="novoProduto()">Novo</button>
        <button class="btn btn-secondary flex-fill" onclick="proximo()">&gt;&gt;</button>
      </div>
    </div>
  </div>

  <!-- FORM -->
  <div class="card d-none" id="formCard">
    <div class="card-body">
      <h6 id="formTitulo"></h6>

      <div class="mb-2">
        <input id="formNome" class="form-control" placeholder="Produto">
      </div>

      <div class="mb-2 d-flex gap-2">
        <input id="formEan" class="form-control" placeholder="EAN">
        <button class="btn btn-outline-secondary" onclick="abrirCameraFormulario()">ðŸ“·</button>
      </div>

      <div class="mb-2">
        <input id="formPreco" type="number" step="0.01" class="form-control">
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-success flex-fill" onclick="salvarProduto()">Salvar</button>
        <button class="btn btn-secondary flex-fill" onclick="cancelarFormulario()">Cancelar</button>
      </div>
    </div>
  </div>

</div>

<!-- MODAL CAMERA -->
<div class="modal fade" id="cameraModal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-body p-0">
        <div id="cameraView"></div>
        <button class="btn btn-danger w-100" onclick="fecharCamera()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<script>
  let destinoEan = null;

  function iniciarCamera(callback) {
    destinoEan = callback;

    const modal = new bootstrap.Modal(document.getElementById("cameraModal"));
    modal.show();

    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: document.querySelector("#cameraView"),
        constraints: {
          facingMode: "environment"
        }
      },
      decoder: {
        readers: ["ean_reader", "ean_13_reader"]
      }
    }, err => {
      if (!err) Quagga.start();
    });

    Quagga.onDetected(onDetectado);
  }

  function onDetectado(result) {
    const code = result.codeResult.code;
    if (!code) return;

    Quagga.offDetected(onDetectado);
    Quagga.stop();
    bootstrap.Modal.getInstance(document.getElementById("cameraModal")).hide();

    destinoEan(code);
  }

  function fecharCamera() {
    Quagga.stop();
    bootstrap.Modal.getInstance(document.getElementById("cameraModal")).hide();
  }

  /* FUNÃ‡Ã•ES SEPARADAS */

  function abrirCameraFormulario() {
    iniciarCamera(code => {
      document.getElementById("formEan").value = code;
    });
  }

  function abrirCameraBusca() {
    iniciarCamera(code => {
      campoBusca.value = code;
      buscarProdutos();
    });
  }
</script>

</body>
</html>