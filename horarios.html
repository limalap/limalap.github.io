<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Horários de ônibus</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container py-4" style="max-width: 700px;">

  <!-- TÍTULO + BOTÃO NOVO -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Horários</h4>
    <button id="btnNovo" class="btn btn-success btn-sm">Novo horário</button>
  </div>

  <!-- PAINEL DE FILTROS -->
  <div id="filtros" class="card shadow-sm mb-3">
    <div class="card-body">

      <div class="row g-2">
        <div class="col-6">
          <select id="filtroLinha" class="form-control">
            <option value="">Todas as linhas</option>
          </select>
        </div>

        <div class="col-6">
          <select id="filtroDia" class="form-control">
            <option value="">Todos os dias</option>
            <option value="seg">Segunda</option>
            <option value="ter">Terça</option>
            <option value="qua">Quarta</option>
            <option value="qui">Quinta</option>
            <option value="sex">Sexta</option>
            <option value="sab">Sábado</option>
            <option value="dom">Domingo</option>
          </select>
        </div>
      </div>

    </div>
  </div>

  <!-- FORMULÁRIO -->
  <div id="formContainer" class="card shadow-sm mb-3" style="display:none;">
    <div class="card-body">

      <form id="form">
        <input type="hidden" id="indiceEdicao">

        <div class="mb-3">
          <label class="form-label">Linha</label>
          <select id="linha" class="form-control"></select>
        </div>

        <div class="mb-3">
          <label class="form-label">Horário de partida</label>
          <input id="horario" type="time" step="1" class="form-control">
        </div>

        <div class="mb-3">
          <label class="form-label">Tempo estimado</label>
          <select id="tempo" class="form-control"></select>
        </div>

        <div class="mb-3">
          <label class="form-label">Dias da semana</label>

          <div class="d-flex flex-wrap gap-3">
            <label><input type="checkbox" class="dia" value="seg"> Seg</label>
            <label><input type="checkbox" class="dia" value="ter"> Ter</label>
            <label><input type="checkbox" class="dia" value="qua"> Qua</label>
            <label><input type="checkbox" class="dia" value="qui"> Qui</label>
            <label><input type="checkbox" class="dia" value="sex"> Sex</label>
            <label><input type="checkbox" class="dia" value="sab"> Sab</label>
            <label><input type="checkbox" class="dia" value="dom"> Dom</label>
          </div>

          <button id="btnDiasUteis" type="button" class="btn btn-outline-primary btn-sm mt-2">
            Dias úteis
          </button>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button id="btnSalvar" type="submit" class="btn btn-primary flex-fill" style="max-width:33%">Salvar</button>
          <button id="btnCancelar" type="button" class="btn btn-secondary flex-fill" style="max-width:33%">Cancelar</button>
          <button id="btnExcluir" type="button" class="btn btn-danger flex-fill" style="max-width:33%; display:none;">Excluir</button>
        </div>

      </form>
    </div>
  </div>

  <!-- LISTA -->
  <ul id="lista" class="list-group"></ul>

</div>

<script>
  function descricaoLinha(valor) {
    const banco = JSON.parse(localStorage.getItem('bancoLinha')) || [];
    const item = banco.find(l => l.linha === valor);
    return item ? `${item.linha} – ${item.origem} → ${item.destino}` : valor;
  }

  function carregarSelectLinhas() {
    const banco = JSON.parse(localStorage.getItem('bancoLinha')) || [];
    const selects = [document.getElementById('linha'), document.getElementById('filtroLinha')];

    selects.forEach(sel => sel.innerHTML = sel.id === 'filtroLinha'
      ? '<option value="">Todas as linhas</option>'
      : '');

    banco.forEach(item => {
      const texto = descricaoLinha(item.linha);

      const op1 = new Option(texto, item.linha);
      const op2 = new Option(texto, item.linha);

      document.getElementById('linha').add(op1);
      document.getElementById('filtroLinha').add(op2);
    });
  }

  function carregarSelectTempo() {
    const select = document.getElementById('tempo');
    for (let i = 5; i <= 120; i += 5) {
      select.add(new Option(i + ' minutos', i));
    }
  }

  function carregarLista() {
    const banco = JSON.parse(localStorage.getItem('bancoHorario')) || [];
    const filtroLinha = document.getElementById('filtroLinha').value;
    const filtroDia = document.getElementById('filtroDia').value;
    const lista = document.getElementById('lista');

    lista.innerHTML = '';

    banco.forEach((item, index) => {
      if (filtroLinha && item.linha !== filtroLinha) return;
      if (filtroDia && (!item.dias || !item.dias.split(',').includes(filtroDia))) return;

      const li = document.createElement('li');
      li.className = "list-group-item d-flex justify-content-between align-items-center";

      li.innerHTML = `
        <span>
          ${descricaoLinha(item.linha)}<br>
          Partida: ${item.horario} • Tempo: ${item.tempo} min<br>
          Dias: ${item.dias}
        </span>
        <button class="btn btn-warning btn-sm" onclick="editar(${index})">Editar</button>
      `;

      lista.appendChild(li);
    });
  }

  function mostrarForm() {
    formContainer.style.display = 'block';
    lista.style.display = 'none';
    filtros.style.display = 'none';
  }

  function esconderForm() {
    formContainer.style.display = 'none';
    lista.style.display = 'block';
    filtros.style.display = 'block';
  }

  btnNovo.onclick = () => {
    form.reset();
    indiceEdicao.value = '';
    btnExcluir.style.display = 'none';
    btnSalvar.textContent = 'Salvar';
    document.querySelectorAll('.dia').forEach(c => c.checked = false);
    mostrarForm();
  };

  btnCancelar.onclick = esconderForm;

  btnDiasUteis.onclick = () => {
    const uteis = ['seg','ter','qua','qui','sex'];
    const todos = document.querySelectorAll('.dia');
    const ativos = uteis.every(d => document.querySelector(`.dia[value="${d}"]`).checked);

    todos.forEach(c => c.checked = false);
    if (!ativos) uteis.forEach(d => document.querySelector(`.dia[value="${d}"]`).checked = true);
  };

  form.onsubmit = e => {
    e.preventDefault();

    const dias = [...document.querySelectorAll('.dia:checked')].map(c => c.value).join(',');
    const banco = JSON.parse(localStorage.getItem('bancoHorario')) || [];

    const obj = {
      linha: linha.value,
      horario: horario.value,
      tempo: tempo.value,
      dias
    };

    if (indiceEdicao.value === '') banco.push(obj);
    else banco[indiceEdicao.value] = obj;

    localStorage.setItem('bancoHorario', JSON.stringify(banco));
    esconderForm();
    carregarLista();
  };

  function editar(index) {
    const banco = JSON.parse(localStorage.getItem('bancoHorario'));
    const item = banco[index];

    linha.value = item.linha;
    horario.value = item.horario;
    tempo.value = item.tempo;
    indiceEdicao.value = index;

    document.querySelectorAll('.dia').forEach(c => c.checked = item.dias.includes(c.value));

    btnExcluir.style.display = 'block';
    btnSalvar.textContent = 'Atualizar';
    mostrarForm();
  }

  btnExcluir.onclick = () => {
    if (!confirm('Você realmente quer deletar esse item?')) return;
    const banco = JSON.parse(localStorage.getItem('bancoHorario'));
    banco.splice(indiceEdicao.value, 1);
    localStorage.setItem('bancoHorario', JSON.stringify(banco));
    esconderForm();
    carregarLista();
  };

  filtroLinha.onchange = filtroDia.onchange = carregarLista;

  window.onload = () => {
    carregarSelectLinhas();
    carregarSelectTempo();
    carregarLista();
  };
</script>

</body>
</html>