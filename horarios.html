<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Horários de Ônibus</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container py-4" style="max-width: 700px;">
  <h4 class="text-center mb-4">Horários de Ônibus</h4>

  <!-- FILTROS -->
  <div id="painelFiltros" class="card shadow-sm mb-3">
    <div class="card-body">

      <div class="mb-3">
        <label class="form-label">Linha</label>
        <select id="filtroLinha" class="form-select"></select>
      </div>

      <div class="d-flex gap-2 align-items-end">
        <div style="flex:1">
          <label class="form-label">Dia</label>
          <select id="filtroDia" class="form-select">
            <option value="seg">Segunda</option>
            <option value="ter">Terça</option>
            <option value="qua">Quarta</option>
            <option value="qui">Quinta</option>
            <option value="sex">Sexta</option>
            <option value="sab">Sábado</option>
            <option value="dom">Domingo</option>
          </select>
        </div>

        <button id="btnHoje" class="btn btn-outline-secondary mb-1"></button>
        <button id="btnImportExport" class="btn btn-outline-primary mb-1">Importar / Exportar</button>
      </div>

    </div>
  </div>

  <button id="btnNovo" class="btn btn-success w-100 mb-3">Novo horário</button>

  <!-- LISTA -->
  <ul id="lista" class="list-group"></ul>

  <!-- FORM HORÁRIO -->
  <div id="formHorario" class="card shadow-sm d-none mt-3">
    <div class="card-body">
      <h5 class="mb-3">Horário</h5>
      <input type="hidden" id="indiceHorario">

      <div class="mb-3">
        <label class="form-label">Linha</label>
        <select id="linhaHorario" class="form-select"></select>
      </div>

      <div class="mb-3">
        <label class="form-label">Horário</label>
        <input type="time" step="1" id="hora" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">Tempo estimado (min)</label>
        <select id="tempo" class="form-select"></select>
      </div>

      <div class="mb-2">Dias da semana</div>
      <div id="diasCheckbox" class="d-flex flex-wrap gap-2 mb-2"></div>
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="toggleDiasUteis()">Dias úteis</button>

      <div class="d-flex">
        <button class="btn btn-primary w-33" onclick="salvarHorario()">Salvar</button>
        <button class="btn btn-secondary w-33" onclick="cancelarHorario()">Cancelar</button>
        <button id="btnDeletar" class="btn btn-danger w-33 d-none" onclick="deletarHorario()">Deletar</button>
      </div>
    </div>
  </div>

  <!-- IMPORT / EXPORT -->
  <div id="formImportExport" class="card shadow-sm d-none mt-3">
    <div class="card-body">
      <h5 class="mb-3">Importar / Exportar</h5>

      <div class="mb-3">
        <label class="form-label">Linha</label>
        <input id="linhaImport" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">JSON</label>
        <textarea id="jsonImport" rows="6" class="form-control"></textarea>
      </div>

      <div class="d-flex">
        <button class="btn btn-primary w-33" onclick="aplicarImport()">Atualizar</button>
        <button class="btn btn-secondary w-33" onclick="fecharImport()">Cancelar</button>
        <button class="btn btn-outline-secondary w-33" onclick="copiarJSON()">Copiar</button>
      </div>
    </div>
  </div>
</div>

<style>
.w-33 { width: 33.33%; }
</style>

<script>
const DIAS = ['seg','ter','qua','qui','sex','sab','dom'];

function getBanco(n){ return JSON.parse(localStorage.getItem(n)) || []; }
function setBanco(n,v){ localStorage.setItem(n,JSON.stringify(v)); }

function normalizarHorario(h){
  if(!h.dias) h.dias = DIAS.join(',');
  if(Array.isArray(h.dias)) h.dias = h.dias.join(',');
  return h;
}

window.onload = () => {
  setBanco('bancoHorario', getBanco('bancoHorario').map(normalizarHorario));
  carregarLinhas();
  carregarDias();
  carregarTempo();
  setDiaHoje();
  atualizarBotaoHoje();
  carregarLista();
  setInterval(atualizarBotaoHoje,60000);
};

function carregarLinhas(){
  const linhas = getBanco('bancoLinha');
  [filtroLinha, linhaHorario].forEach(sel=>{
    sel.innerHTML='';
    linhas.forEach(l=>{
      const o=document.createElement('option');
      o.value=l.linha;
      o.textContent=`${l.linha} - ${l.origem} → ${l.destino}`;
      sel.appendChild(o);
    });
  });
  if(linhas.length) filtroLinha.value = linhas[0].linha;
}

function setDiaHoje(){
  const d=new Date().getDay();
  filtroDia.value = DIAS[d===0?6:d-1];
}

function atualizarBotaoHoje(){
  const d=new Date();
  const m=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  btnHoje.textContent=`${d.getDate()} ${m[d.getMonth()]}, ${d.toLocaleTimeString().slice(0,5)}`;
}

btnHoje.onclick=()=>{ setDiaHoje(); carregarLista(); };
filtroLinha.onchange=filtroDia.onchange=carregarLista;

function carregarLista(){
  lista.innerHTML='';
  const banco=getBanco('bancoHorario');

  banco.forEach((h,i)=>{
    h=normalizarHorario(h);
    if(h.linha!==filtroLinha.value) return;
    if(h.dias && !h.dias.includes(filtroDia.value)) return;

    const li=document.createElement('li');
    li.className='list-group-item';

    li.innerHTML = `
      <div><strong>Linha:</strong> ${h.linha}</div>
      <div><strong>Horário:</strong> ${h.hora}</div>
      <div><strong>Tempo:</strong> ${h.tempo} min</div>
      <div><strong>Dias:</strong> ${h.dias}</div>
      <div class="mt-2 text-end">
        <button class="btn btn-sm btn-warning">Editar</button>
      </div>
    `;

    li.querySelector('button').onclick=()=>editarHorario(i);
    lista.appendChild(li);
  });
}

/* restante do código permanece igual */
</script>

</body>
</html>