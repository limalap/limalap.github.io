<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Horários de Ônibus</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container py-4" style="max-width: 700px;">
  <h4 class="text-center mb-4">Horários de Ônibus</h4>

  <!-- FILTROS -->
  <div id="painelFiltros" class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Linha</label>
        <select id="filtroLinha" class="form-select"></select>
      </div>

      <div class="d-flex gap-2 align-items-end">
        <div style="flex:1">
          <label class="form-label">Dia</label>
          <select id="filtroDia" class="form-select">
            <option value="seg">Segunda</option>
            <option value="ter">Terça</option>
            <option value="qua">Quarta</option>
            <option value="qui">Quinta</option>
            <option value="sex">Sexta</option>
            <option value="sab">Sábado</option>
            <option value="dom">Domingo</option>
          </select>
        </div>

        <button id="btnHoje" class="btn btn-outline-secondary mb-1"></button>
        <button id="btnImportExport" class="btn btn-outline-primary mb-1">Importar / Exportar</button>
      </div>
    </div>
  </div>

  <button id="btnNovo" class="btn btn-success w-100 mb-3">Novo horário</button>

  <ul id="lista" class="list-group"></ul>

  <!-- FORM HORÁRIO -->
  <div id="formHorario" class="card shadow-sm d-none mt-3">
    <div class="card-body">
      <h5 class="mb-3">Horário</h5>
      <input type="hidden" id="indiceHorario">

      <div class="mb-3">
        <label class="form-label">Linha</label>
        <select id="linhaHorario" class="form-select"></select>
      </div>

      <div class="mb-3">
        <label class="form-label">Horário</label>
        <input type="time" step="1" id="hora" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">Tempo estimado (min)</label>
        <select id="tempo" class="form-select"></select>
      </div>

      <div class="mb-2">Dias da semana</div>
      <div id="diasCheckbox" class="d-flex flex-wrap gap-2 mb-2"></div>
      <button class="btn btn-sm btn-outline-secondary mb-3" onclick="toggleDiasUteis()">Dias úteis</button>

      <div class="d-flex">
        <button class="btn btn-primary w-33" onclick="salvarHorario()">Salvar</button>
        <button class="btn btn-secondary w-33" onclick="cancelarHorario()">Cancelar</button>
        <button id="btnDeletar" class="btn btn-danger w-33 d-none" onclick="deletarHorario()">Deletar</button>
      </div>
    </div>
  </div>

  <!-- IMPORT / EXPORT -->
  <div id="formImportExport" class="card shadow-sm d-none mt-3">
    <div class="card-body">
      <h5 class="mb-3">Importar / Exportar</h5>

      <div class="mb-3">
        <label class="form-label">Linha</label>
        <input id="linhaImport" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">JSON</label>
        <textarea id="jsonImport" rows="6" class="form-control"></textarea>
      </div>

      <div class="d-flex">
        <button class="btn btn-primary w-33" onclick="aplicarImport()">Atualizar</button>
        <button class="btn btn-secondary w-33" onclick="fecharImport()">Cancelar</button>
        <button class="btn btn-outline-secondary w-33" onclick="copiarJSON()">Copiar</button>
      </div>
    </div>
  </div>
</div>

<style>
.w-33{width:33.33%}
</style>

<script>
const DIAS = ['seg','ter','qua','qui','sex','sab','dom'];

function getBanco(n){ return JSON.parse(localStorage.getItem(n)) || []; }
function setBanco(n,v){ localStorage.setItem(n,JSON.stringify(v)); }

function normalizarHorario(h){
  if(!h.dias) h.dias = DIAS.join(',');
  if(Array.isArray(h.dias)) h.dias = h.dias.join(',');
  return h;
}

function normalizarBanco(){
  const banco = getBanco('bancoHorario').map(normalizarHorario);
  setBanco('bancoHorario', banco);
}

window.onload = () => {
  normalizarBanco();
  carregarLinhas();
  carregarDias();
  carregarTempo();
  setDiaHoje();
  atualizarBotaoHoje();
  carregarLista();
  setInterval(atualizarBotaoHoje,60000);
};

function carregarLinhas(){
  const linhas = getBanco('bancoLinha');
  [filtroLinha, linhaHorario].forEach(sel=>{
    sel.innerHTML='';
    linhas.forEach(l=>{
      const o=document.createElement('option');
      o.value=l.linha;
      o.textContent=`${l.linha} - ${l.origem} → ${l.destino}`;
      sel.appendChild(o);
    });
  });
  if(linhas.length) filtroLinha.value = linhas[0].linha;
}

function setDiaHoje(){
  filtroDia.value = DIAS[new Date().getDay()===0?6:new Date().getDay()-1];
}

function atualizarBotaoHoje(){
  const d=new Date();
  const m=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  btnHoje.textContent=`${d.getDate()} ${m[d.getMonth()]}, ${d.toLocaleTimeString().slice(0,5)}`;
}

btnHoje.onclick=()=>{ setDiaHoje(); carregarLista(); };
filtroLinha.onchange=filtroDia.onchange=carregarLista;

function carregarLista(){
  lista.innerHTML='';
  const banco=getBanco('bancoHorario');
  banco.forEach((h,i)=>{
    h=normalizarHorario(h);
    if(h.linha!==filtroLinha.value) return;
    if(h.dias && !h.dias.includes(filtroDia.value)) return;

    const li=document.createElement('li');
    li.className='list-group-item d-flex justify-content-between';
    li.innerHTML=`<span>${h.hora} (${h.tempo} min)</span>
      <button class="btn btn-sm btn-warning">Editar</button>`;
    li.querySelector('button').onclick=()=>editarHorario(i);
    lista.appendChild(li);
  });
}

function carregarDias(){
  diasCheckbox.innerHTML='';
  DIAS.forEach(d=>{
    diasCheckbox.innerHTML+=`<label><input type="checkbox" value="${d}"> ${d}</label>`;
  });
}

function carregarTempo(){
  for(let i=5;i<=120;i+=5){
    tempo.innerHTML+=`<option value="${i}">${i}</option>`;
  }
}

function toggleDiasUteis(){
  const uteis=['seg','ter','qua','qui','sex'];
  const checks=[...document.querySelectorAll('#diasCheckbox input')];
  const todosMarcados=checks.filter(c=>uteis.includes(c.value)).every(c=>c.checked);
  checks.forEach(c=>{
    if(uteis.includes(c.value)) c.checked=!todosMarcados;
  });
}

function abrirForm(){
  painelFiltros.classList.add('d-none');
  lista.classList.add('d-none');
  formHorario.classList.remove('d-none');
}

btnNovo.onclick=()=>{ indiceHorario.value=''; btnDeletar.classList.add('d-none'); abrirForm(); };

function editarHorario(i){
  const h=getBanco('bancoHorario')[i];
  abrirForm();
  indiceHorario.value=i;
  linhaHorario.value=h.linha;
  hora.value=h.hora;
  tempo.value=h.tempo;
  document.querySelectorAll('#diasCheckbox input').forEach(c=>{
    c.checked=h.dias.includes(c.value);
  });
  btnDeletar.classList.remove('d-none');
}

function salvarHorario(){
  const diasSel=[...document.querySelectorAll('#diasCheckbox input:checked')].map(c=>c.value);
  if(!diasSel.length) return alert('Selecione ao menos um dia');
  const banco=getBanco('bancoHorario');
  const obj=normalizarHorario({
    linha:linhaHorario.value,
    hora:hora.value,
    tempo:tempo.value,
    dias:diasSel.join(',')
  });
  if(indiceHorario.value==='') banco.push(obj);
  else banco[indiceHorario.value]=obj;
  setBanco('bancoHorario',banco);
  cancelarHorario();
}

function cancelarHorario(){
  formHorario.classList.add('d-none');
  painelFiltros.classList.remove('d-none');
  lista.classList.remove('d-none');
  carregarLista();
}

function deletarHorario(){
  if(!confirm('você realmente quer deletar esse item?')) return;
  const banco=getBanco('bancoHorario');
  banco.splice(indiceHorario.value,1);
  setBanco('bancoHorario',banco);
  cancelarHorario();
}

btnImportExport.onclick=()=>{
  painelFiltros.classList.add('d-none');
  lista.classList.add('d-none');
  formImportExport.classList.remove('d-none');
  linhaImport.value=filtroLinha.value;
  jsonImport.value=JSON.stringify(
    getBanco('bancoHorario').filter(h=>h.linha===filtroLinha.value),
    null,2
  );
};

function fecharImport(){
  formImportExport.classList.add('d-none');
  painelFiltros.classList.remove('d-none');
  lista.classList.remove('d-none');
}

function aplicarImport(){
  try{
    const dados=JSON.parse(jsonImport.value).map(d=>normalizarHorario({
      ...d, linha:linhaImport.value
    }));
    setBanco('bancoHorario',getBanco('bancoHorario').concat(dados));
    fecharImport();
    carregarLista();
  }catch{
    alert('JSON inválido');
  }
}

function copiarJSON(){
  navigator.clipboard.writeText(jsonImport.value);
}
</script>

</body>
</html>